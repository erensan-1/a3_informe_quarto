<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Enrique Reñé Sánchez (Técnico SIG)">
<meta name="author" content="Cristian González Alonso (Ingeniero de datos)">
<meta name="author" content="Juan Jorge Rosales León (Dirección técnica)">
<meta name="dcterms.date" content="2025-09-25">

<title>Metodología empleada para la resolución de la Tarea A3 ‘Vías sin código de vía INE’</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(mapas/FONDO_IT_1.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light">

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-right">
      <h1 class="title">Metodología empleada para la resolución de la Tarea A3 ‘Vías sin código de vía INE’</h1>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author column-page-right">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Enrique Reñé Sánchez (Técnico SIG)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <img src="mapas/GRAFCANa_logo_color.png" class="img-fluid" style="width:1in" alt="GRAFCAN Logo">
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Cristian González Alonso (Ingeniero de datos)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Juan Jorge Rosales León (Dirección técnica)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
        </div>
    </div>

  <div class="quarto-title-meta column-page-right">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 25, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#sec-resumen" id="toc-sec-resumen" class="nav-link active" data-scroll-target="#sec-resumen"><span class="header-section-number">1</span> Resumen</a>
  <ul>
  <li><a href="#información-de-partida-y-análisis-exploratorio" id="toc-información-de-partida-y-análisis-exploratorio" class="nav-link" data-scroll-target="#información-de-partida-y-análisis-exploratorio"><span class="header-section-number">1.1</span> Información de partida y análisis exploratorio</a></li>
  <li><a href="#fuentes-de-datos-empleadas" id="toc-fuentes-de-datos-empleadas" class="nav-link" data-scroll-target="#fuentes-de-datos-empleadas"><span class="header-section-number">1.2</span> Fuentes de datos empleadas</a></li>
  </ul></li>
  <li><a href="#flujo-metodológico" id="toc-flujo-metodológico" class="nav-link" data-scroll-target="#flujo-metodológico"><span class="header-section-number">2</span> Flujo metodológico</a>
  <ul>
  <li><a href="#preparación-del-entorno" id="toc-preparación-del-entorno" class="nav-link" data-scroll-target="#preparación-del-entorno"><span class="header-section-number">2.1</span> Preparación del entorno</a></li>
  <li><a href="#normalización" id="toc-normalización" class="nav-link" data-scroll-target="#normalización"><span class="header-section-number">2.2</span> Normalización</a></li>
  <li><a href="#modelo-machine-learning-para-clasificación-de-emparejamientos" id="toc-modelo-machine-learning-para-clasificación-de-emparejamientos" class="nav-link" data-scroll-target="#modelo-machine-learning-para-clasificación-de-emparejamientos"><span class="header-section-number">2.3</span> Modelo machine learning para clasificación de emparejamientos</a>
  <ul class="collapse">
  <li><a href="#entrenamiento-del-modelo-random-forest" id="toc-entrenamiento-del-modelo-random-forest" class="nav-link" data-scroll-target="#entrenamiento-del-modelo-random-forest"><span class="header-section-number">2.3.1</span> Entrenamiento del modelo Random Forest</a></li>
  <li><a href="#evaluación-del-modelo" id="toc-evaluación-del-modelo" class="nav-link" data-scroll-target="#evaluación-del-modelo"><span class="header-section-number">2.3.2</span> Evaluación del modelo</a></li>
  </ul></li>
  <li><a href="#asignación-de-código-cvia_ine-o-up" id="toc-asignación-de-código-cvia_ine-o-up" class="nav-link" data-scroll-target="#asignación-de-código-cvia_ine-o-up"><span class="header-section-number">2.4</span> Asignación de código (CVIA_INE o UP)</a>
  <ul class="collapse">
  <li><a href="#filtro-heurístico" id="toc-filtro-heurístico" class="nav-link" data-scroll-target="#filtro-heurístico"><span class="header-section-number">2.4.1</span> Filtro heurístico</a></li>
  <li><a href="#bucle-principal-de-asignación-y-etiquetado" id="toc-bucle-principal-de-asignación-y-etiquetado" class="nav-link" data-scroll-target="#bucle-principal-de-asignación-y-etiquetado"><span class="header-section-number">2.4.2</span> Bucle principal de asignación y etiquetado</a></li>
  <li><a href="#asignación-universal-de-código-de-up" id="toc-asignación-universal-de-código-de-up" class="nav-link" data-scroll-target="#asignación-universal-de-código-de-up"><span class="header-section-number">2.4.3</span> Asignación universal de código de UP</a></li>
  </ul></li>
  <li><a href="#postprocesado-y-exportación" id="toc-postprocesado-y-exportación" class="nav-link" data-scroll-target="#postprocesado-y-exportación"><span class="header-section-number">2.5</span> Postprocesado y exportación</a></li>
  <li><a href="#resumen-de-asignaciones" id="toc-resumen-de-asignaciones" class="nav-link" data-scroll-target="#resumen-de-asignaciones"><span class="header-section-number">2.6</span> Resumen de asignaciones</a></li>
  </ul></li>
  <li><a href="#resultados" id="toc-resultados" class="nav-link" data-scroll-target="#resultados"><span class="header-section-number">3</span> Resultados</a>
  <ul>
  <li><a href="#evaluación-del-modelo-random-forest" id="toc-evaluación-del-modelo-random-forest" class="nav-link" data-scroll-target="#evaluación-del-modelo-random-forest"><span class="header-section-number">3.1</span> Evaluación del modelo Random Forest</a></li>
  <li><a href="#distribución-general-y-por-municipio" id="toc-distribución-general-y-por-municipio" class="nav-link" data-scroll-target="#distribución-general-y-por-municipio"><span class="header-section-number">3.2</span> Distribución general y por municipio</a></li>
  <li><a href="#productos-cartográficos" id="toc-productos-cartográficos" class="nav-link" data-scroll-target="#productos-cartográficos"><span class="header-section-number">3.3</span> Productos cartográficos</a></li>
  <li><a href="#visor" id="toc-visor" class="nav-link" data-scroll-target="#visor"><span class="header-section-number">3.4</span> Visor</a></li>
  </ul></li>
  <li><a href="#análisis-del-residuo" id="toc-análisis-del-residuo" class="nav-link" data-scroll-target="#análisis-del-residuo"><span class="header-section-number">4</span> Análisis del residuo</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block column-page-right" id="quarto-document-content">





<div id="238a080e" class="cell" data-execution_count="1">
<div class="cell-output cell-output-display">

<div class="card mb-3" style="padding:10px; background-color:#f8f9fa; border-left: 5px solid #09488bff;">
  <strong>Proyecto:</strong> Tenerife Padrón 2.0 (Cabildo Tenerife) - Padrón Online (INE)
</div>
</div>
</div>
<p>Mediante la Orden TER/1235/2023 (E2025001009), el Cabildo de Tenerife encarga a Cartográfica de Canarias S.A. (GRAFCAN) la ejecución de tareas de análisis y depuración del padrón de municipios de menos de 20.000 habitantes, en el marco del proyecto <em>TenerifePadrón 2.0</em>, encuadrado a su vez en la iniciativa <em>Padrón Online</em> del INE.</p>
<section id="sec-resumen" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Resumen</h1>
<p>Este documento describe la metodología empleada para la resolución de la Tarea A3 (‘Registros del fichero de Viviendas sin código de vía INE’), que consiste en la asignación de código de vía en formato INE (cvia_ine en adelante) para aquellas viviendas no principales cuya vía catastral no se ha podido identificar en el callejero del censo electoral.</p>
<p>La aproximación se centra en la asignación de cvia_ine (o código de unidad poblacional en su defecto, tal y como recoge la <a href="mapas/Guia_Tecnica_de_Subvenciones.pdf" target="_blank">Guía Técnica de Subvenciones</a>), mediante ubicación espacial de la vivienda y análisis de vecindad con cartografía de portales o vías del callejero de SITCAN, así como cartografía de unidades poblacionales. Además de la asignación de cvia_ine o código de unidad poblacional (UP en adelante), se clasifican los registros de acuerdo a su emparejamiento en base a las descripciones de su dirección.</p>
<p>Dada la variedad en los formatos de nomenclatura y la incompletitud de las descripciones, se ha optado por emplear métodos de emparejamiento basados en heurística y machine learning para determinar si la dirección de ambas fuentes hace referencia a la misma localización. La utilidad de esto último radica en la capacidad de discernir aquellas vías con nombres alternativos o vías existentes en SITCAN pero no recogidas por el INE que proponen para darse de alta por parte de los ayuntamientos.</p>
<p>Los resultados muestran un <strong>88,48% de asignación</strong> de ‘cvia_ine’ a nivel global tras la comparación con la fuente de datos de portales y vías recogidas en el callejero de SITCAN. El residuo se reparte en un 10,76% de viviendas propuesta para asignar nueva vía (existe en callejero pero no en el INE), un 0,52% de viviendas aisladas y un 0,22% a las que únicamente se le ha podido asignar código UP, ambas por falta de vías cercanas existentes.</p>
<p>El desarrollo y resultados de los trabajos se plasman en el presente informe, así como en el <a href="mapas/A3_Atlas.pdf" target="_blank">atlas</a> o el <a href="https://erensan-1.github.io/a3_visor/" target="_blank">visor</a> que muestra la distribución espacial de las viviendas para cada municipio.</p>
<section id="información-de-partida-y-análisis-exploratorio" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="información-de-partida-y-análisis-exploratorio"><span class="header-section-number">1.1</span> Información de partida y análisis exploratorio</h2>
<p>La información proporcionada por el INE es la siguiente:</p>
<ul>
<li><em>Registros afectados del fichero de viviendas con dirección catastral (VCppmmml.023)</em></li>
</ul>
<p>Este fichero contiene un total de 14.723 registros repartidos en 913 vías, la situación de partida por municipios se muestra en la siguiente tabla:</p>
<div id="d5c8a0b2" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">

<div style="display: flex; justify-content: space-between; gap: 20px;">
  <div style="flex: 1;"><table class="dataframe table table-sm table-striped small">
  <thead>
    <tr>
      <th>Código</th>
      <th>Municipio</th>
      <th>Nº viviendas</th>
      <th>Nº vías</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>004</td>
      <td>Arafo</td>
      <td>1097</td>
      <td>94</td>
    </tr>
    <tr>
      <td>005</td>
      <td>Arico</td>
      <td>1417</td>
      <td>118</td>
    </tr>
    <tr>
      <td>010</td>
      <td>Buenavista del Norte</td>
      <td>696</td>
      <td>66</td>
    </tr>
    <tr>
      <td>012</td>
      <td>Fasnia</td>
      <td>955</td>
      <td>41</td>
    </tr>
    <tr>
      <td>015</td>
      <td>Garachico</td>
      <td>672</td>
      <td>53</td>
    </tr>
    <tr>
      <td>018</td>
      <td>Guancha, La</td>
      <td>283</td>
      <td>17</td>
    </tr>
    <tr>
      <td>025</td>
      <td>Matanza de Acentejo, La</td>
      <td>382</td>
      <td>31</td>
    </tr>
    <tr>
      <td>032</td>
      <td>Rosario, El</td>
      <td>3215</td>
      <td>165</td>
    </tr>
    <tr>
      <td>034</td>
      <td>San Juan de la Rambla</td>
      <td>576</td>
      <td>46</td>
    </tr>
  </tbody>
</table></div>
  <div style="flex: 1;"><table class="dataframe table table-sm table-striped small">
  <thead>
    <tr>
      <th>Código</th>
      <th>Municipio</th>
      <th>Nº viviendas</th>
      <th>Nº vías</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>039</td>
      <td>Santa Úrsula</td>
      <td>528</td>
      <td>29</td>
    </tr>
    <tr>
      <td>040</td>
      <td>Santiago del Teide</td>
      <td>1078</td>
      <td>34</td>
    </tr>
    <tr>
      <td>041</td>
      <td>Sauzal, El</td>
      <td>964</td>
      <td>43</td>
    </tr>
    <tr>
      <td>042</td>
      <td>Silos, Los</td>
      <td>667</td>
      <td>56</td>
    </tr>
    <tr>
      <td>044</td>
      <td>Tanque, El</td>
      <td>156</td>
      <td>16</td>
    </tr>
    <tr>
      <td>046</td>
      <td>Tegueste</td>
      <td>750</td>
      <td>51</td>
    </tr>
    <tr>
      <td>051</td>
      <td>Victoria de Acentejo, La</td>
      <td>1015</td>
      <td>23</td>
    </tr>
    <tr>
      <td>052</td>
      <td>Vilaflor de Chasna</td>
      <td>272</td>
      <td>30</td>
    </tr>
    <tr>
      <td>Total</td>
      <td>Todos</td>
      <td>14723</td>
      <td>913</td>
    </tr>
  </tbody>
</table></div>
</div>
</div>
</div>
</section>
<section id="fuentes-de-datos-empleadas" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="fuentes-de-datos-empleadas"><span class="header-section-number">1.2</span> Fuentes de datos empleadas</h2>
<p>El análisis espacial se realizó comparando con las siguientes fuentes de información:</p>
<ul>
<li><p><strong>Callejero del SITCAN</strong> (Sistema de Información Territorial de Canarias): gestionado y mantenido por GRAFCAN, constituye la base oficial de referencia para la red viaria de Canarias. Se ha utilizado la cartografía de portales y vías de callejero.</p></li>
<li><p><strong>Poblaciones</strong>: base de datos con información georreferenciada de poblaciones publicada por el Instituto Geográfico Nacional (IGN). Si bien</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>La práctica totalidad de las asignaciones de cvia_ine se recuperaron mediante la vía espacial frente a callejero, dado que en la mayoría de los casos existían portales en la misma parcela que contenía la vivienda o vías cercanas a la misma. Tan sólo una pequeña proporción de viviendas tienen como única asignación el código UP, tras incapacidad de asociar cvia_ine. No obstante, como información adicional se ha recuperado el código UP para todos los registros siempre que no fuera nulo.</p>
</div>
</div></li>
</ul>
</section>
</section>
<section id="flujo-metodológico" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Flujo metodológico</h1>
<p>La asignación de código a cada vivienda se desarrolla en una secuencia de etapas, resumidas a continuación para proporcionar una visión global del proceso:</p>
<ol type="1">
<li><p><strong>Preparación del entorno:</strong></p>
<ul>
<li><p>Importación de librerías para manejo de datos (<code>pandas</code>, <code>geopandas</code>, <code>sqlalchemy</code>), geoprocesamiento (<code>shapely</code>), coincidencia difusa (<code>rapidfuzz</code>) y conexión a PostgreSQL/PostGIS.</p></li>
<li><p>Definición de diccionarios de normalización: equivalencias oficiales de siglas para desabreviación, casos de abreviación detectados manualmente y diccionario de municipios.</p></li>
</ul></li>
<li><p><strong>Carga de datos</strong>: conexión a la base de datos para obtener los registros y las fuentes a comparar (portales y vías del callejero SITCAN, parcelas catastrales y unidades poblacionales).</p></li>
<li><p><strong>Normalización y limpieza</strong>: para mejorar la capacidad de emparejamiento se aplican una serie de funciones de preprocesamiento (conversión a mayúsculas, eliminación de acentos y carácteres especiales, separación de sufijos y prefijos, etc). Dicho proceso se aplica tanto al registro procedente del fichero VC como al de la fuente contra la que se compara.</p></li>
<li><p><strong>Entrenamiento del modelo</strong> de Machine Learning para el emparejamiento de las direcciones:</p>
<ul>
<li><p>Se calculan distintas métricas de similitud que serán las variables de entrada como <em>fuzz ratio</em>, <em>partial ratio</em>, <em>token sort ratio</em>, <em>token set ratio</em>, <em>Wratio</em>, <em>length difference</em>, <em>first token equal</em> y <em>last token equal</em>. Se puede consultar el significado de cada métrica <a href="https://rapidfuzz.github.io/RapidFuzz/Usage/fuzz.html" target="_blank">aquí</a>.</p></li>
<li><p>Se entrena un modelo <strong>Random Forest</strong> usando un dataset de validación manual, se evalúa su desempeño con métricas de clasificación y se analiza la importancia de las variables.</p></li>
<li><p>Se combina este clasificador con un filtro heurístico previo que asigna como emparejamiento aquellas comparaciones cuyo WRatio sea mayor de 95% y no emparejados aquellas comparaciones cuyo valor sea menor al 60%.</p></li>
</ul></li>
<li><p><strong>Asignación de código (cvia_ine o UP)</strong>:</p>
<p>Para el conjunto de las 14.273 viviendas se itera sobre cada registro filtrando por municipio y se establece un orden de prioridad para la asignación de cvia_ine o UP, así como el etiquetado según su estado:</p>
<ol type="1">
<li><p><strong>Vivienda contenida en una parcela donde existe portal</strong>: si existe coincidencia espacial de una vivienda y un portal dentro de una misma parcela catastral, se asigna el cvia_ine de portal a la vivienda.</p></li>
<li><p><strong>Vivienda con vías cercanas</strong>: cuando no se da el primer supuesto, se buscan las vías cercanas contenidas en un buffer de 100 m y se asigna el cvia_ine de aquella con una mayor similitud de emparejamiento (se aplica el modelo de machine learning).</p></li>
<li><p><strong>Viviendas aisladas</strong>: si no existen vías en un radio de 100 m, se asigna el cvia_ine correspondiente a la vía más cercana.</p></li>
</ol>
<p>Cada asignación incluye información sobre el origen y método de asignación o la métrica de probabilidad estimada por el modelo, así como otros metadatos recogidos en nuevas columnas.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Independientemente de la asignación de cvia_ine, se recupera el código de unidad poblacional siempre que la vivienda exista dentro de la geometría de unidades poblacionales y esta contenga un código no nulo.</p>
</div>
</div>
<p>Dado que aquellos cvia_ine con codificación superior a 90.000 se corresponden con vías recogidas en callejero pero inexistentes en la base de datos del INE, dichas vías se identifican como posibles nuevas altas a proponer por los ayuntamientos, recibiendo la etiqueta ‘Asignar Vía Nueva’. La lógica seguida para el etiquetado de cada registros se muestra en la siguiente imagen:</p></li>
</ol>
<p><img src="images/A3_estado_v2.drawio-3.png" class="img-fluid" style="display:block; margin-left:auto; margin-right:auto; width:700px;"></p>
<ol start="6" type="1">
<li><p><strong>Postprocesado y exportación de resultados</strong>: se corrigen formatos y se exportan resultados a Excel y CSV.</p></li>
<li><p><strong>Resumen final de asignaciones</strong>: se imprime un conteo de viviendas en cada estado y el total de registros procesados.</p></li>
<li><p><strong>Ficheros de salida</strong>:</p>
<p>Tras la asignación de cvia_ine o UP a los registros y su marcaje de propuesta para vías de nueva alta a los ayuntamiento, se generan los siguientes archivos de salida de acuerdo con la estructura de datos establecida en a <a href="mapas/Guia_Tecnica_de_Subvenciones.pdf" target="_blank">Guía Técnica de Subvenciones</a>:</p>
<ul>
<li><em>VCppmmmA.023: registros afectados del fichero de viviendas con dirección catastral y código de vía del callejero de censo electoral.</em></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>De forma complementaria se muestra las definciones del etiquetado empleado de manera interna para controlar la calidad de los datos:</p>
<div id="22d19546" class="cell" data-execution_count="3">
<div class="cell-output cell-output-display" data-execution_count="3">
<table class="dataframe table table-sm table-striped small" id="tabla_codigos">
  <thead>
    <tr>
      <th>Código</th>
      <th>Estado</th>
      <th>Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>A3_NoAplicable</td>
      <td>Vivienda principal o registro no afectado por A3.</td>
    </tr>
    <tr>
      <td>2</td>
      <td>A3_Pendiente</td>
      <td>Registro pendiente de procesamiento.</td>
    </tr>
    <tr>
      <td>3</td>
      <td>A3_AsignadaVia</td>
      <td>Vivienda con vía asignada (cvia_ine válido) por coincidencia en la dirección de portal o vía próxima.</td>
    </tr>
    <tr>
      <td>4</td>
      <td>A3_AsignadaViaAlternativa</td>
      <td>Vivienda con vía alternativa asignada (cvia_ine válido) por proximidad pero sin coincidencia en la dirección de portal o vía próxima.</td>
    </tr>
    <tr>
      <td>5</td>
      <td>A3_AsignadaUnidadPoblacional</td>
      <td>Vivienda sin cvia_ine asignado por falta de cvia_ine o falta de vecindad, pero con pertenencia a una Unidad Poblacional.</td>
    </tr>
    <tr>
      <td>6</td>
      <td>A3_AsignarViaNueva</td>
      <td>Vivienda inexistente en el INE (sin cvia_ine o descripción no coincidente) pero recogida en el callejero de SITCAN que se propone como nueva alta para el ayuntamiento.</td>
    </tr>
    <tr>
      <td>7</td>
      <td>A3_Aislada</td>
      <td>Vivienda sin cvia_ine asignado por falta de vecindad a portales o vías y sin pertenencia a una Unidad Poblacional. Se le asigna el cvia_ine de la vía más próxima.</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div></li>
</ol>
<section id="preparación-del-entorno" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="preparación-del-entorno"><span class="header-section-number">2.1</span> Preparación del entorno</h2>
<p>Carga de librerías necesarias:</p>
<div id="20ca8e09" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === LIBRERÍAS NECESARIAS ===</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> unicodedata</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rapidfuzz <span class="im">import</span> process, fuzz</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely <span class="im">import</span> make_valid</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Carga de datos:</p>
<div id="0a58367b" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === CONEXIÓN A LA BASE DE DATOS ===</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conectando a la base de datos..."</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>DB_URI <span class="op">=</span> <span class="st">"postgresql+psycopg2://erensan:5eP79ECt@192.168.21.226:5432/padron_online"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> create_engine(DB_URI)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># === CARGA DE DATOS ===</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>df_vv <span class="op">=</span> gpd.read_postgis(<span class="st">"SELECT * FROM trabajo.vivienda"</span>, engine, geom_col<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total viviendas cargadas:"</span>, <span class="bu">len</span>(df_vv))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>df_vc <span class="op">=</span> df_vv[df_vv[<span class="st">'cvia_ine'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Viviendas con cvia_ine == 0:"</span>, <span class="bu">len</span>(df_vc))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>df_callejero_num <span class="op">=</span> gpd.read_postgis(<span class="st">"SELECT * FROM grafcan.callejero_num"</span>, engine, geom_col<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portales cargados:"</span>, <span class="bu">len</span>(df_callejero_num))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>df_callejero_via <span class="op">=</span> gpd.read_postgis(<span class="st">"SELECT * FROM grafcan.callejero_via"</span>, engine, geom_col<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Vías cargadas:"</span>, <span class="bu">len</span>(df_callejero_via))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>df_parcela <span class="op">=</span> gpd.read_postgis(<span class="st">"SELECT * FROM catastro.parcela WHERE tipo != 'X'"</span>, engine, geom_col<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Parcelas cargadas (tipo distinto de 'X'):"</span>, <span class="bu">len</span>(df_parcela))</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>df_poblaciones <span class="op">=</span> gpd.read_postgis(<span class="st">"SELECT * FROM age.poblaciones"</span>, engine, geom_col<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span><span class="st">'EPSG:4326'</span> )</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Poblaciones cargadas:"</span>, <span class="bu">len</span>(df_poblaciones))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Inicializar campos auxiliares:</p>
<div id="4716bc20" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === INICIALIZAR CAMPOS AUXILIARES ===</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'cvia_ine'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'a3_origen'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'a3_metodo'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'a3_uuid'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'cod_pob'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'predict_proba'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'direccion_norm_vc'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'direccion_norm_callejero'</span>] <span class="op">=</span> <span class="st">''</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Diccionario de abreviaciones:</p>
<div id="5e344002" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === DICCIONARIO DE SIGLAS DE VÍA ===</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>SIGLAS_VIA <span class="op">=</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AL'</span>: <span class="st">'ALAMEDA'</span>, <span class="st">'AD'</span>: <span class="st">'ALDEA'</span>, <span class="st">'AP'</span>: <span class="st">'APARTAMENTOS'</span>, <span class="st">'AY'</span>: <span class="st">'ARROYO'</span>, <span class="st">'AV'</span>: <span class="st">'AVENIDA'</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BJ'</span>: <span class="st">'BAJADA'</span>, <span class="st">'BR'</span>: <span class="st">'BARRANCO'</span>, <span class="st">'BO'</span>: <span class="st">'BARRIO'</span>, <span class="st">'BL'</span>: <span class="st">'BLOQUE'</span>, <span class="st">'CL'</span>: <span class="st">'CALLE'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CJ'</span>: <span class="st">'CALLEJA'</span>, <span class="st">'CM'</span>: <span class="st">'CAMINO'</span>, <span class="st">'CR'</span>: <span class="st">'CARRERA'</span>, <span class="st">'CS'</span>: <span class="st">'CASERIO'</span>, <span class="st">'CH'</span>: <span class="st">'CHALET'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CO'</span>: <span class="st">'COLONIA'</span>, <span class="st">'CN'</span>: <span class="st">'COSTANILLA'</span>, <span class="st">'CT'</span>: <span class="st">'CARRETERA'</span>, <span class="st">'CU'</span>: <span class="st">'CUESTA'</span>, <span class="st">'ED'</span>: <span class="st">'EDIFICIO'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EL'</span>: <span class="st">'ESCALINATA'</span>, <span class="st">'ES'</span>: <span class="st">'ESCALERA'</span>, <span class="st">'GL'</span>: <span class="st">'GLORIETA'</span>, <span class="st">'GR'</span>: <span class="st">'GRUPO'</span>, <span class="st">'LG'</span>: <span class="st">'LUGAR'</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MC'</span>: <span class="st">'MERCADO'</span>, <span class="st">'MN'</span>: <span class="st">'MUNICIPIO'</span>, <span class="st">'MZ'</span>: <span class="st">'MANZANA'</span>, <span class="st">'PA'</span>: <span class="st">'PASEO ALTO'</span>, <span class="st">'PB'</span>: <span class="st">'POBLADO'</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PD'</span>: <span class="st">'PASADIZO'</span>, <span class="st">'PJ'</span>: <span class="st">'PASAJE'</span>, <span class="st">'PL'</span>: <span class="st">'PLACETA'</span>, <span class="st">'PO'</span>: <span class="st">'PASEO BAJO'</span>, <span class="st">'PP'</span>: <span class="st">'PASEO'</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PQ'</span>: <span class="st">'PARQUE'</span>, <span class="st">'PR'</span>: <span class="st">'PORTALES'</span>, <span class="st">'PS'</span>: <span class="st">'PASO'</span>, <span class="st">'PT'</span>: <span class="st">'PATIO'</span>, <span class="st">'PU'</span>: <span class="st">'PLAZUELA'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PZ'</span>: <span class="st">'PLAZA'</span>, <span class="st">'RA'</span>: <span class="st">'RAMAL'</span>, <span class="st">'RB'</span>: <span class="st">'RAMBLA'</span>, <span class="st">'RC'</span>: <span class="st">'RINCONADA'</span>, <span class="st">'RD'</span>: <span class="st">'RONDA'</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RP'</span>: <span class="st">'RAMPA'</span>, <span class="st">'RR'</span>: <span class="st">'RIBERA'</span>, <span class="st">'SC'</span>: <span class="st">'SECTOR'</span>, <span class="st">'SD'</span>: <span class="st">'SENDA'</span>, <span class="st">'SU'</span>: <span class="st">'SUBIDA'</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TO'</span>: <span class="st">'TORRE'</span>, <span class="st">'TR'</span>: <span class="st">'TRAVESÍA'</span>, <span class="st">'UR'</span>: <span class="st">'URBANIZACIÓN'</span>, <span class="st">'URB'</span>: <span class="st">'URBANIZACIÓN'</span>, <span class="st">'VI'</span>: <span class="st">'VÍA'</span>, <span class="st">'ZO'</span>: <span class="st">'ZONA'</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AVDA'</span>: <span class="st">'AVENIDA'</span>, <span class="st">'CTRA'</span>: <span class="st">'CARRETERA'</span>, <span class="st">'CLLON'</span>: <span class="st">'CALLEJON'</span>, <span class="st">'TRVA'</span>: <span class="st">'TRAVESIA'</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CMNO'</span>: <span class="st">'CAMINO'</span>, <span class="st">'PSAJE'</span>: <span class="st">'PASAJE'</span>, <span class="st">'BRANC'</span>: <span class="st">'BARRANCO'</span>, <span class="st">'PZTA'</span>: <span class="st">'PLAZOLETA'</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'POLIG'</span>: <span class="st">'POLIGONO'</span>, <span class="st">'BARDA'</span>: <span class="st">'BARRIADA'</span>, <span class="st">'TRVAL'</span>: <span class="st">'TRASVERSAL'</span>, <span class="st">'ACCES'</span>: <span class="st">'ACCESO'</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CZDA'</span>: <span class="st">'CALZADA'</span>, <span class="st">'CZADA'</span>: <span class="st">'CALZADA'</span>, <span class="st">'VREDA'</span>: <span class="st">'VEREDA'</span>, <span class="st">'PG'</span>:<span class="st">'POLIGONO'</span>, <span class="st">'FCO RGUEZ'</span>: <span class="st">'FRANCISCO RODRIGUEZ'</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Diccionario de municipios:</p>
<div id="7e7feed2" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === DICCIONARIO DE MUNICIPIOS ===</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>municipios <span class="op">=</span> {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38004"</span>: <span class="st">"Arafo"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38005"</span>: <span class="st">"Arico"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38010"</span>: <span class="st">"Buenavista del Norte"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38012"</span>: <span class="st">"Fasnia"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38015"</span>: <span class="st">"Garachico"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38018"</span>: <span class="st">"Guancha, La"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38025"</span>: <span class="st">"Matanza de Acentejo, La"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38032"</span>: <span class="st">"Rosario, El"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38034"</span>: <span class="st">"San Juan de la Rambla"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38039"</span>: <span class="st">"Santa Úrsula"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38040"</span>: <span class="st">"Santiago del Teide"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38041"</span>: <span class="st">"Sauzal, El"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38042"</span>: <span class="st">"Silos, Los"</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38044"</span>: <span class="st">"Tanque, El"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38046"</span>: <span class="st">"Tegueste"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38051"</span>: <span class="st">"Victoria de Acentejo, La"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"38052"</span>: <span class="st">"Vilaflor de Chasna"</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="normalización" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="normalización"><span class="header-section-number">2.2</span> Normalización</h2>
<p>Definición de funciones de limpieza y normalización de las direcciones:</p>
<div id="c4a6eb49" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === FUNCIONES AUXILIARES ===</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> limpiar_texto(texto):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(texto, <span class="bu">str</span>):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        texto <span class="op">=</span> <span class="bu">str</span>(texto)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> texto.upper().strip()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> unicodedata.normalize(<span class="st">'NFKD'</span>, texto)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">''</span>.join(c <span class="cf">for</span> c <span class="kw">in</span> texto <span class="cf">if</span> <span class="kw">not</span> unicodedata.combining(c))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalizar_via_nombre(tvia, nvia):</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    tvia_raw <span class="op">=</span> SIGLAS_VIA.get(<span class="bu">str</span>(tvia).strip().upper(), <span class="bu">str</span>(tvia))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    tvia_norm <span class="op">=</span> limpiar_texto(tvia_raw)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    nvia_norm <span class="op">=</span> limpiar_texto(nvia)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>tvia_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>nvia_norm<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corregir_geoms(gdf, nombre):</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - </span><span class="sc">{</span>nombre<span class="sc">}</span><span class="ss"> inicial: </span><span class="sc">{</span><span class="bu">len</span>(gdf)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    gdf[<span class="st">'geom'</span>] <span class="op">=</span> gdf[<span class="st">'geom'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> g: make_valid(g) <span class="cf">if</span> g <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    gdf <span class="op">=</span> gdf[gdf.is_valid <span class="op">&amp;</span> <span class="op">~</span>gdf.is_empty]</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - </span><span class="sc">{</span>nombre<span class="sc">}</span><span class="ss"> válidas: </span><span class="sc">{</span><span class="bu">len</span>(gdf)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aplicación de funciones de normalización y corrección de geometrías:</p>
<div id="3af75942" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === NORMALIZACIÓN ===</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Normalizando nombres de vías..."</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'direccion_norm'</span>] <span class="op">=</span> df_vc.<span class="bu">apply</span>(<span class="kw">lambda</span> r: normalizar_via_nombre(r[<span class="st">'tvia_dgc'</span>], r[<span class="st">'nvia_dgc'</span>]), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>df_callejero_num[<span class="st">'direccion_norm'</span>] <span class="op">=</span> df_callejero_num.<span class="bu">apply</span>(<span class="kw">lambda</span> r: normalizar_via_nombre(r[<span class="st">'tipovia'</span>], r[<span class="st">'nombrevia'</span>]), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df_callejero_via[<span class="st">'direccion_norm'</span>] <span class="op">=</span> df_callejero_via.<span class="bu">apply</span>(<span class="kw">lambda</span> r: normalizar_via_nombre(r[<span class="st">'tipovia'</span>], r[<span class="st">'nombrevia'</span>]), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Corrigiendo geometrías..."</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df_vc <span class="op">=</span> corregir_geoms(df_vc, <span class="st">"Viviendas"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df_parcela <span class="op">=</span> corregir_geoms(df_parcela, <span class="st">"Parcelas"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>df_callejero_num <span class="op">=</span> corregir_geoms(df_callejero_num, <span class="st">"Portales"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>df_callejero_via <span class="op">=</span> corregir_geoms(df_callejero_via, <span class="st">"Vías"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="modelo-machine-learning-para-clasificación-de-emparejamientos" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="modelo-machine-learning-para-clasificación-de-emparejamientos"><span class="header-section-number">2.3</span> Modelo machine learning para clasificación de emparejamientos</h2>
<section id="entrenamiento-del-modelo-random-forest" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="entrenamiento-del-modelo-random-forest"><span class="header-section-number">2.3.1</span> Entrenamiento del modelo Random Forest</h3>
<p>La muestra de los 177 registros a los que se les ha realizado validación manual y se han proporcionado como verdad terreno para entrenar al modelo se puede <a href="mapas/muestra_match_manual.xlsx">descargar aquí</a>.</p>
<div id="12a05309" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === ENTRENAR MODELO RF CON VALIDACIÓN ===</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Entrenando clasificador ML..."</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_features(vc, callejero):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ratio"</span>: fuzz.ratio(vc, callejero),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"partial_ratio"</span>: fuzz.partial_ratio(vc, callejero),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"token_sort_ratio"</span>: fuzz.token_sort_ratio(vc, callejero),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"token_set_ratio"</span>: fuzz.token_set_ratio(vc, callejero),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wratio"</span>: fuzz.WRatio(vc, callejero),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"len_diff"</span>: <span class="bu">abs</span>(<span class="bu">len</span>(vc) <span class="op">-</span> <span class="bu">len</span>(callejero)),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"first_token_equal"</span>: <span class="bu">int</span>(vc.split()[<span class="dv">0</span>] <span class="op">==</span> callejero.split()[<span class="dv">0</span>]) <span class="cf">if</span> vc <span class="kw">and</span> callejero <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"last_token_equal"</span>: <span class="bu">int</span>(vc.split()[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> callejero.split()[<span class="op">-</span><span class="dv">1</span>]) <span class="cf">if</span> vc <span class="kw">and</span> callejero <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar excel con validación manual</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pd.read_excel(<span class="st">"sample_direcciones_para_match_manual.xlsx"</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>feature_rows <span class="op">=</span> []</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> df_test.iterrows():</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(row[<span class="st">'match_manual'</span>]):</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Asegurarse de que las direcciones no sean nulas</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    direccion_vc <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">'direccion_norm_vc'</span>]) <span class="cf">if</span> pd.notna(row[<span class="st">'direccion_norm_vc'</span>]) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    direccion_callejero <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">'direccion_norm_callejero'</span>]) <span class="cf">if</span> pd.notna(row[<span class="st">'direccion_norm_callejero'</span>]) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    feats <span class="op">=</span> compute_features(direccion_vc, direccion_callejero)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    feature_rows.append(feats)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    labels.append(<span class="bu">int</span>(row[<span class="st">'match_manual'</span>]))</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> pd.DataFrame(feature_rows)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> pd.Series(labels)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">"balanced"</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="evaluación-del-modelo" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="evaluación-del-modelo"><span class="header-section-number">2.3.2</span> Evaluación del modelo</h3>
<div id="a6cd0da4" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Evaluación del modelo ===</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Evaluación del modelo ==="</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Matriz de confusión:"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(y_test, y_pred))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># === Importancia de cada variable ===</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>feature_importances <span class="op">=</span> pd.DataFrame({</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'feature'</span>: X.columns,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'importance'</span>: clf.feature_importances_</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>}).sort_values(by<span class="op">=</span><span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Importancia de las variables ==="</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importances)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráfico de importancia</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>plt.barh(feature_importances[<span class="st">'feature'</span>], feature_importances[<span class="st">'importance'</span>])</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>plt.gca().invert_yaxis()  <span class="co"># Mostrar la más importante arriba</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Importancia de cada variable en el Random Forest"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Importancia"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="asignación-de-código-cvia_ine-o-up" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="asignación-de-código-cvia_ine-o-up"><span class="header-section-number">2.4</span> Asignación de código (CVIA_INE o UP)</h2>
<section id="filtro-heurístico" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="filtro-heurístico"><span class="header-section-number">2.4.1</span> Filtro heurístico</h3>
<div id="86d10523" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filtro_heuristico(vc, callejero):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    tsr_set <span class="op">=</span> fuzz.token_set_ratio(vc, callejero)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    wr <span class="op">=</span> fuzz.WRatio(vc, callejero)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tsr_set <span class="op">&gt;=</span> <span class="dv">95</span>:</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> wr <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decidir_match(vc, callejero, clf<span class="op">=</span>clf):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> filtro_heuristico(vc, callejero)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> h <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> h</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    feats <span class="op">=</span> pd.DataFrame([compute_features(vc, callejero)])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>(clf.predict(feats)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bucle-principal-de-asignación-y-etiquetado" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="bucle-principal-de-asignación-y-etiquetado"><span class="header-section-number">2.4.2</span> Bucle principal de asignación y etiquetado</h3>
<div id="cf8fc832" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === PROCESAR MUNICIPIO POR MUNICIPIO === </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> codmun, nombre <span class="kw">in</span> municipios.items():</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Procesando municipio </span><span class="sc">{</span>nombre<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>codmun<span class="sc">}</span><span class="ss">)..."</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    mun_id <span class="op">=</span> <span class="bu">int</span>(codmun[<span class="op">-</span><span class="dv">2</span>:])</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    df_vc_mun <span class="op">=</span> df_vc[df_vc[<span class="st">'cmun_ine'</span>].astype(<span class="bu">int</span>) <span class="op">==</span> mun_id].copy()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    df_parcela_mun <span class="op">=</span> df_parcela[df_parcela[<span class="st">'municipio'</span>].astype(<span class="bu">int</span>) <span class="op">==</span> mun_id].copy()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    df_callejero_num_mun <span class="op">=</span> df_callejero_num[df_callejero_num[<span class="st">'codmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:].astype(<span class="bu">int</span>) <span class="op">==</span> mun_id].copy()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    df_callejero_via_mun <span class="op">=</span> df_callejero_via[df_callejero_via[<span class="st">'codmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:].astype(<span class="bu">int</span>) <span class="op">==</span> mun_id].copy()</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    df_poblaciones_mun <span class="op">=</span> df_poblaciones.copy()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_vc_mun.empty:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  No hay viviendas para este municipio."</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    vc_parcela <span class="op">=</span> gpd.sjoin(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        df_vc_mun,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        df_parcela_mun[[<span class="st">'refcat'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        predicate<span class="op">=</span><span class="st">"within"</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> tqdm(vc_parcela.iterrows(), total<span class="op">=</span>vc_parcela.shape[<span class="dv">0</span>], desc<span class="op">=</span><span class="ss">f"Procesando </span><span class="sc">{</span>nombre<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        refcat <span class="op">=</span> row[<span class="st">'refcat'</span>]</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        geom_vc <span class="op">=</span> row[<span class="st">'geom'</span>]</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        df_vc.at[idx, <span class="st">'direccion_norm_vc'</span>] <span class="op">=</span> row[<span class="st">'direccion_norm'</span>]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PRIORIDAD 1: PORTALES EN LA PARCELA</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(refcat):</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            parcela_geom <span class="op">=</span> df_parcela_mun.loc[df_parcela_mun[<span class="st">'refcat'</span>] <span class="op">==</span> refcat, <span class="st">'geom'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            cn_candidatos <span class="op">=</span> df_callejero_num_mun[df_callejero_num_mun.within(parcela_geom)]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>            cn_candidatos <span class="op">=</span> gpd.GeoDataFrame(columns<span class="op">=</span>df_callejero_num_mun.columns, geometry<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span>df_callejero_num_mun.crs)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> cn_candidatos.empty:</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>            matches <span class="op">=</span> process.extractOne(row[<span class="st">'direccion_norm'</span>], cn_candidatos[<span class="st">'direccion_norm'</span>].tolist(), scorer<span class="op">=</span>fuzz.WRatio)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> matches:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                match_name <span class="op">=</span> matches[<span class="dv">0</span>]</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                feats <span class="op">=</span> pd.DataFrame([compute_features(row[<span class="st">'direccion_norm'</span>], match_name)])</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                proba <span class="op">=</span> clf.predict_proba(feats)[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'predict_proba'</span>] <span class="op">=</span> proba</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                match_label <span class="op">=</span> decidir_match(row[<span class="st">'direccion_norm'</span>], match_name, clf)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                codvia <span class="op">=</span> cn_candidatos.loc[cn_candidatos[<span class="st">'direccion_norm'</span>] <span class="op">==</span> match_name, <span class="st">'codvia'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                uuid_match <span class="op">=</span> cn_candidatos.loc[cn_candidatos[<span class="st">'direccion_norm'</span>] <span class="op">==</span> match_name, <span class="st">'uuid'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'cvia_ine'</span>] <span class="op">=</span> codvia</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_origen'</span>] <span class="op">=</span> <span class="st">'callejero_num'</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'direccion_norm_callejero'</span>] <span class="op">=</span> match_name</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_metodo'</span>] <span class="op">=</span> <span class="st">'heurística'</span> <span class="cf">if</span> filtro_heuristico(row[<span class="st">'direccion_norm'</span>], match_name) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">'random_forest'</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_uuid'</span>] <span class="op">=</span> uuid_match</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"NONE"</span> <span class="kw">in</span> <span class="bu">str</span>(row[<span class="st">'direccion_norm'</span>]) <span class="kw">or</span> <span class="st">"NONE"</span> <span class="kw">in</span> <span class="bu">str</span>(match_name):</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignadaViaAlternativa'</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignadaVia'</span> <span class="cf">if</span> match_label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'A3_AsignadaViaAlternativa'</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">int</span>(codvia) <span class="op">&gt;</span> <span class="dv">90000</span>:</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignarViaNueva'</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PRIORIDAD 2: VÍAS CERCANAS</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">True</span>:</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>            buffer_geom <span class="op">=</span> geom_vc.<span class="bu">buffer</span>(<span class="dv">100</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>            vias_cercanas <span class="op">=</span> df_callejero_via_mun[df_callejero_via_mun.intersects(buffer_geom)]</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> vias_cercanas.empty:</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                matches <span class="op">=</span> process.extractOne(row[<span class="st">'direccion_norm'</span>], vias_cercanas[<span class="st">'direccion_norm'</span>].tolist(), scorer<span class="op">=</span>fuzz.WRatio)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> matches:</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>                    match_name <span class="op">=</span> matches[<span class="dv">0</span>]</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>                    feats <span class="op">=</span> pd.DataFrame([compute_features(row[<span class="st">'direccion_norm'</span>], match_name)])</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                    proba <span class="op">=</span> clf.predict_proba(feats)[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'predict_proba'</span>] <span class="op">=</span> proba</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>                    match_label <span class="op">=</span> decidir_match(row[<span class="st">'direccion_norm'</span>], match_name, clf)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>                    codvia <span class="op">=</span> vias_cercanas.loc[vias_cercanas[<span class="st">'direccion_norm'</span>] <span class="op">==</span> match_name, <span class="st">'codvia'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>                    uuid_match <span class="op">=</span> vias_cercanas.loc[vias_cercanas[<span class="st">'direccion_norm'</span>] <span class="op">==</span> match_name, <span class="st">'uuid'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'cvia_ine'</span>] <span class="op">=</span> codvia</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_origen'</span>] <span class="op">=</span> <span class="st">'callejero_via'</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'direccion_norm_callejero'</span>] <span class="op">=</span> match_name</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_metodo'</span>] <span class="op">=</span> <span class="st">'heurística'</span> <span class="cf">if</span> filtro_heuristico(row[<span class="st">'direccion_norm'</span>], match_name) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">'random_forest'</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>                    df_vc.at[idx, <span class="st">'a3_uuid'</span>] <span class="op">=</span> uuid_match</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">"NONE"</span> <span class="kw">in</span> <span class="bu">str</span>(row[<span class="st">'direccion_norm'</span>]) <span class="kw">or</span> <span class="st">"NONE"</span> <span class="kw">in</span> <span class="bu">str</span>(match_name):</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>                        df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignadaViaAlternativa'</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>                        df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignadaVia'</span> <span class="cf">if</span> match_label <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">'A3_AsignadaViaAlternativa'</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">int</span>(codvia) <span class="op">&gt;</span> <span class="dv">90000</span>:</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>                        df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignarViaNueva'</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PRIORIDAD 3: VIVIENDA AISLADA</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==============================</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isna(df_vc.at[idx, <span class="st">'a3_estado'</span>]) <span class="kw">or</span> df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">==</span> <span class="st">''</span>:</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>            gdf_row <span class="op">=</span> gpd.GeoDataFrame([row], geometry<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span>df_vc.crs)</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Buscar vía más cercana</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>            nearest <span class="op">=</span> gpd.sjoin_nearest(</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>                gdf_row,</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>                df_callejero_via_mun[[<span class="st">'geom'</span>,<span class="st">'codvia'</span>,<span class="st">'uuid'</span>]],</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>                how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>                rsuffix<span class="op">=</span><span class="st">'_right'</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Detectar columnas candidatas</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>            uuid_candidates <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> nearest.columns <span class="cf">if</span> c.startswith(<span class="st">"uuid"</span>)]</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>            codvia_candidates <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> nearest.columns <span class="cf">if</span> c.startswith(<span class="st">"codvia"</span>)]</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>            uuid_col <span class="op">=</span> uuid_candidates[<span class="dv">0</span>] <span class="cf">if</span> uuid_candidates <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>            codvia_col <span class="op">=</span> codvia_candidates[<span class="dv">0</span>] <span class="cf">if</span> codvia_candidates <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Asignar siempre cvia_ine y uuid si existe algo en nearest</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> nearest.empty <span class="kw">and</span> uuid_col <span class="kw">and</span> codvia_col:</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'cvia_ine'</span>] <span class="op">=</span> nearest[codvia_col].iloc[<span class="dv">0</span>]</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_uuid'</span>] <span class="op">=</span> nearest[uuid_col].iloc[<span class="dv">0</span>]</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Intentar asignar unidad poblacional</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>            df_poblaciones_clean <span class="op">=</span> df_poblaciones_mun[[<span class="st">'cunn_1'</span>,<span class="st">'geom'</span>]].copy()</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>            poblacion <span class="op">=</span> gpd.sjoin(</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>                gdf_row,</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>                df_poblaciones_clean,</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>                how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>                predicate<span class="op">=</span><span class="st">'within'</span>,</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>                rsuffix<span class="op">=</span><span class="st">'_pob'</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> poblacion.empty <span class="kw">and</span> pd.notna(poblacion[<span class="st">'cunn_1'</span>].iloc[<span class="dv">0</span>]):</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'cod_pob'</span>] <span class="op">=</span> poblacion[<span class="st">'cunn_1'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_AsignadaUnidadPoblacional'</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>                df_vc.at[idx, <span class="st">'a3_estado'</span>] <span class="op">=</span> <span class="st">'A3_Aislada'</span></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Asignar metadatos</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>            df_vc.at[idx, <span class="st">'a3_origen'</span>] <span class="op">=</span> <span class="st">'callejero_via'</span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>            df_vc.at[idx, <span class="st">'direccion_norm_callejero'</span>] <span class="op">=</span> <span class="st">''</span> <span class="cf">if</span> nearest.empty <span class="cf">else</span> df_vc.at[idx, <span class="st">'direccion_norm_callejero'</span>]</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>            df_vc.at[idx, <span class="st">'a3_metodo'</span>] <span class="op">=</span> <span class="st">'random_forest'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="asignación-universal-de-código-de-up" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="asignación-universal-de-código-de-up"><span class="header-section-number">2.4.3</span> Asignación universal de código de UP</h3>
<div id="51c1080a" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    df_poblaciones_clean <span class="op">=</span> df_poblaciones_mun[[<span class="st">'cunn_1'</span>, <span class="st">'geom'</span>]].copy()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    vc_con_pob <span class="op">=</span> gpd.sjoin(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        df_vc_mun,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        df_poblaciones_clean,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        predicate<span class="op">=</span><span class="st">"within"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        rsuffix<span class="op">=</span><span class="st">"_pob"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> vc_con_pob.iterrows():</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(row[<span class="st">'cunn_1'</span>]):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            df_vc.at[idx, <span class="st">'cod_pob'</span>] <span class="op">=</span> row[<span class="st">'cunn_1'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="postprocesado-y-exportación" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="postprocesado-y-exportación"><span class="header-section-number">2.5</span> Postprocesado y exportación</h2>
<div id="0ca5a2dc" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CORREGIR FORMATO CODVIA</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_vc[<span class="st">'cvia_ine'</span>] <span class="op">=</span> df_vc[<span class="st">'cvia_ine'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">str</span>(x).zfill(<span class="dv">5</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>df_vc.loc[(df_vc[<span class="st">"direccion_norm_vc"</span>].<span class="bu">str</span>.contains(<span class="st">"NONE"</span>, na<span class="op">=</span><span class="va">False</span>) <span class="op">|</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>     df_vc[<span class="st">"direccion_norm_callejero"</span>].<span class="bu">str</span>.contains(<span class="st">"NONE"</span>, na<span class="op">=</span><span class="va">False</span>)) <span class="op">&amp;</span> (df_vc[<span class="st">"a3_estado"</span>] <span class="op">==</span> <span class="st">"Asignada"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"a3_estado"</span>] <span class="op">=</span> <span class="st">"AsignadaViaAlternativa"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># EXPORTAR</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'uuid'</span>, <span class="st">'direccion_norm'</span>]:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df_vc.columns:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        df_vc <span class="op">=</span> df_vc.drop(columns<span class="op">=</span>[col])</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Exportando resultados a Excel y CSV..."</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>df_vc.to_excel(<span class="st">"a3_asignaciones_vc.xlsx"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>df_vc.to_csv(<span class="st">"a3_asignaciones_vc.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="resumen-de-asignaciones" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="resumen-de-asignaciones"><span class="header-section-number">2.6</span> Resumen de asignaciones</h2>
<div id="7f29ac4f" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== RESUMEN DE ASIGNACIONES ==="</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>estados <span class="op">=</span> [</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3_AsignadaVia'</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3_AsignadaViaAlternativa'</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3_AsignadaUnidadPoblacional'</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3_AsignarViaNueva'</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3_Aislada'</span>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> estado <span class="kw">in</span> estados:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> df_vc[df_vc[<span class="st">'a3_estado'</span>] <span class="op">==</span> estado].shape[<span class="dv">0</span>]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>estado<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> registros"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros procesados: </span><span class="sc">{</span><span class="bu">len</span>(df_vc)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="resultados" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Resultados</h1>
<p>En términos generales, se ha conseguido la asignación del cvia_ine para la mayoría de registros del fichero VC, y se confirma que el modelo de machine learning para el emparejamiento de direcciones tiene una buena precisión.</p>
<p>El 67% de las asignaciones se han recuperado a través la capa de portales, mientras que la recuperación desde la capa de vías supone un 33%. Asimismo, un 68% de los registros han recibido el emparejamiento a través del filtro heurístico, mientras que el modelo Random Forest ha operado sobre los 4.747 registros restantes (32%).</p>
<p>A continuación se realiza un análisis de los resultados y se visualizan espacialmente en formato atlas y en visor.</p>
<section id="evaluación-del-modelo-random-forest" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="evaluación-del-modelo-random-forest"><span class="header-section-number">3.1</span> Evaluación del modelo Random Forest</h2>
<p>De acuerdo con el informe de la clasificación, el modelo predice correctamente ambas clases (binario de verdad o falso de emparejamiento), con una precisión global del 94% (34 de 36 casos).</p>
<div id="e5b8d626" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="dataframe table table-sm table-striped small" id="tabla_metricas">
  <thead>
    <tr>
      <th>Clase</th>
      <th>Precision</th>
      <th>Recall</th>
      <th>F1-score</th>
      <th>Support</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.95</td>
      <td>0.95</td>
      <td>0.95</td>
      <td>21</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.93</td>
      <td>0.93</td>
      <td>0.93</td>
      <td>15</td>
    </tr>
    <tr>
      <td>Accuracy</td>
      <td>0.94</td>
      <td>-</td>
      <td>-</td>
      <td>36</td>
    </tr>
    <tr>
      <td>Macro avg</td>
      <td>0.94</td>
      <td>0.94</td>
      <td>0.94</td>
      <td>36</td>
    </tr>
    <tr>
      <td>Weighted avg</td>
      <td>0.94</td>
      <td>0.94</td>
      <td>0.94</td>
      <td>36</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>La matriz de confusión solo muestra un error de asignación por clase (habiendo utilizado 36 de los 177 registros para su evaluación), por lo que confirma la buena precisión del modelo.</p>
<div id="f9973a6a" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="5">
<table class="dataframe table table-sm table-striped small" id="tabla_confusion">
  <thead>
    <tr>
      <th></th>
      <th>Pred_0</th>
      <th>Pred_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Real_0</th>
      <td>20</td>
      <td>1</td>
    </tr>
    <tr>
      <th>Real_1</th>
      <td>1</td>
      <td>14</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Las variables token_set_ratio (mide similitud ingorando palabras repetidas o extra), token_sort_ratio (mide similitud ignorando el orden de las palabras) y ratio (captura similitud literal completa) tienen el mayor impacto en las predicciones, mientras que variables como len_diff o last_token_equal tienen baja influencia.</p>
<div id="8b7f9513" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display" data-execution_count="6">
<table class="dataframe table table-sm table-striped small" id="tabla_importancia">
  <thead>
    <tr>
      <th>Variable</th>
      <th>Importancia</th>
      <th>Variable</th>
      <th>Importancia</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>token_set_ratio</td>
      <td>0.197</td>
      <td>wratio</td>
      <td>0.116</td>
    </tr>
    <tr>
      <td>token_sort_ratio</td>
      <td>0.192</td>
      <td>first_token_equal</td>
      <td>0.095</td>
    </tr>
    <tr>
      <td>ratio</td>
      <td>0.154</td>
      <td>last_token_equal</td>
      <td>0.061</td>
    </tr>
    <tr>
      <td>partial_ratio</td>
      <td>0.124</td>
      <td>len_diff</td>
      <td>0.061</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="distribución-general-y-por-municipio" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="distribución-general-y-por-municipio"><span class="header-section-number">3.2</span> Distribución general y por municipio</h2>
<p>Se ha conseguido la asignación del cvia_ine para el <strong>88,48 %</strong> del total de registros del fichero VC, mientras que un 0,52% ha recibido un cvia_ine de la vía más próxima por tratarse de una vivienda aislada y un 0,22% ha recibido únicamente el código de unidad poblacional al no contar con vinculación a cvia_ine posible.</p>
<div id="2d396648" class="cell" data-execution_count="21">
<div class="cell-output cell-output-display" data-execution_count="7">
<table class="dataframe table table-sm table-striped small" id="tabla_resultados">
  <thead>
    <tr>
      <th>Estado</th>
      <th>Cantidad</th>
      <th>Porcentaje</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Asignada Vía Alternativa</td>
      <td>7026</td>
      <td>47.72%</td>
    </tr>
    <tr>
      <td>Asignada Vía</td>
      <td>6002</td>
      <td>40.77%</td>
    </tr>
    <tr>
      <td>Asignar Vía Nueva</td>
      <td>1585</td>
      <td>10.77%</td>
    </tr>
    <tr>
      <td>Aislada</td>
      <td>77</td>
      <td>0.52%</td>
    </tr>
    <tr>
      <td>Asignada Unidad Poblacional</td>
      <td>33</td>
      <td>0.22%</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Analizando la distribución por municipio, se comprueba que en la mayoría de caso la categoría ‘Asignada Vía Alternativa’ es la más frecuente, indicando que se consigue asignar cvia_ine pero sin coincidencia en la dirección de la vía.</p>
<p>Por otro lado, la categoría ‘Asignada Vía’ varía mucho entre municipios, desde valores bajos (Fasnia 16,9%) hasta muy altos (Santiago del Teide 84,3%), lo que es indicativo del grado de completitud de las direcciones o de capacidad de cada ayuntamiento para mantener su callejero con datos actualizados.</p>
<p>Las categorías de asignación UP o viviendas aisladas representan porcentajes muy bajos para todos los municipios, por lo que constituyen situaciones poco frecuentes.</p>
<div id="45a803bf" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display" data-execution_count="8">
<table class="dataframe table table-sm table-striped small" id="tabla_resultados_mun">
  <thead>
    <tr>
      <th>Municipio</th>
      <th>Asignada Vía</th>
      <th>Asignada Vía Alt.</th>
      <th>Asignada U.P.</th>
      <th>Asignar Vía Nueva</th>
      <th>Aislada</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Arafo</td>
      <td>296 (27.0%)</td>
      <td>736 (67.1%)</td>
      <td>0 (0.0%)</td>
      <td>59 (5.4%)</td>
      <td>6 (0.5%)</td>
      <td>1097</td>
    </tr>
    <tr>
      <td>Arico</td>
      <td>724 (51.1%)</td>
      <td>477 (33.7%)</td>
      <td>0 (0.0%)</td>
      <td>207 (14.6%)</td>
      <td>9 (0.6%)</td>
      <td>1417</td>
    </tr>
    <tr>
      <td>Buenavista del Norte</td>
      <td>225 (32.3%)</td>
      <td>298 (42.8%)</td>
      <td>1 (0.1%)</td>
      <td>161 (23.1%)</td>
      <td>11 (1.6%)</td>
      <td>696</td>
    </tr>
    <tr>
      <td>El Rosario</td>
      <td>699 (21.7%)</td>
      <td>1899 (59.1%)</td>
      <td>24 (0.7%)</td>
      <td>580 (18.0%)</td>
      <td>13 (0.4%)</td>
      <td>3215</td>
    </tr>
    <tr>
      <td>El Sauzal</td>
      <td>464 (48.1%)</td>
      <td>443 (46.0%)</td>
      <td>3 (0.3%)</td>
      <td>48 (5.0%)</td>
      <td>6 (0.6%)</td>
      <td>964</td>
    </tr>
    <tr>
      <td>El Tanque</td>
      <td>54 (34.6%)</td>
      <td>31 (19.9%)</td>
      <td>0 (0.0%)</td>
      <td>70 (44.9%)</td>
      <td>1 (0.6%)</td>
      <td>156</td>
    </tr>
    <tr>
      <td>Fasnia</td>
      <td>161 (16.9%)</td>
      <td>616 (64.5%)</td>
      <td>0 (0.0%)</td>
      <td>164 (17.2%)</td>
      <td>14 (1.5%)</td>
      <td>955</td>
    </tr>
    <tr>
      <td>Garachico</td>
      <td>389 (57.9%)</td>
      <td>237 (35.3%)</td>
      <td>1 (0.1%)</td>
      <td>42 (6.2%)</td>
      <td>3 (0.4%)</td>
      <td>672</td>
    </tr>
    <tr>
      <td>La Guancha</td>
      <td>145 (51.2%)</td>
      <td>96 (33.9%)</td>
      <td>0 (0.0%)</td>
      <td>41 (14.5%)</td>
      <td>1 (0.4%)</td>
      <td>283</td>
    </tr>
    <tr>
      <td>La Matanza de Acentejo</td>
      <td>291 (76.2%)</td>
      <td>73 (19.1%)</td>
      <td>2 (0.5%)</td>
      <td>15 (3.9%)</td>
      <td>1 (0.3%)</td>
      <td>382</td>
    </tr>
    <tr>
      <td>La Victoria de Acentejo</td>
      <td>614 (60.5%)</td>
      <td>394 (38.8%)</td>
      <td>0 (0.0%)</td>
      <td>7 (0.7%)</td>
      <td>0 (0.0%)</td>
      <td>1015</td>
    </tr>
    <tr>
      <td>Los Silos</td>
      <td>245 (36.7%)</td>
      <td>349 (52.3%)</td>
      <td>0 (0.0%)</td>
      <td>68 (10.2%)</td>
      <td>5 (0.7%)</td>
      <td>667</td>
    </tr>
    <tr>
      <td>San Juan de la Rambla</td>
      <td>226 (39.2%)</td>
      <td>322 (55.9%)</td>
      <td>0 (0.0%)</td>
      <td>28 (4.9%)</td>
      <td>0 (0.0%)</td>
      <td>576</td>
    </tr>
    <tr>
      <td>Santa Úrsula</td>
      <td>176 (33.3%)</td>
      <td>339 (64.2%)</td>
      <td>0 (0.0%)</td>
      <td>12 (2.3%)</td>
      <td>1 (0.2%)</td>
      <td>528</td>
    </tr>
    <tr>
      <td>Santiago del Teide</td>
      <td>909 (84.3%)</td>
      <td>158 (14.7%)</td>
      <td>1 (0.1%)</td>
      <td>10 (0.9%)</td>
      <td>0 (0.0%)</td>
      <td>1078</td>
    </tr>
    <tr>
      <td>Tegueste</td>
      <td>289 (38.5%)</td>
      <td>428 (57.1%)</td>
      <td>1 (0.1%)</td>
      <td>26 (3.5%)</td>
      <td>6 (0.8%)</td>
      <td>750</td>
    </tr>
    <tr>
      <td>Vilaflor de Chasna</td>
      <td>95 (34.9%)</td>
      <td>130 (47.8%)</td>
      <td>0 (0.0%)</td>
      <td>47 (17.3%)</td>
      <td>0 (0.0%)</td>
      <td>272</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
<section id="productos-cartográficos" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="productos-cartográficos"><span class="header-section-number">3.3</span> Productos cartográficos</h2>
<p>A continuación, se muestra la distribución espacial de las viviendas asignadas a través de una serie de mapas con datos relevantes, así como un visor para una visualización más interactiva que permite explorar zonas con más detalle:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Arafo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Arico</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Buenavista del Norte</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">El Rosario</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">El Sauzal</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false" href="">El Tanque</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false" href="">Fasnia</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false" href="">Garachico</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false" href="">La Guancha</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-10" role="tab" aria-controls="tabset-1-10" aria-selected="false" href="">La Matanza de Acentejo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-11" role="tab" aria-controls="tabset-1-11" aria-selected="false" href="">La Victoria de Acentejo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-12" role="tab" aria-controls="tabset-1-12" aria-selected="false" href="">Los Silos</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-13" role="tab" aria-controls="tabset-1-13" aria-selected="false" href="">San Juan de la Rambla</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-14" role="tab" aria-controls="tabset-1-14" aria-selected="false" href="">Santiago del Teide</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-15-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-15" role="tab" aria-controls="tabset-1-15" aria-selected="false" href="">Tegueste</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-16-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-16" role="tab" aria-controls="tabset-1-16" aria-selected="false" href="">Vilaflor</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p><img src="mapas/Arafo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p><img src="mapas/Arico.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p><img src="mapas/Buenavista%20del%20Norte.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<p><img src="mapas/El%20Rosario.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<p><img src="mapas/El%20Sauzal.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<p><img src="mapas/El%20Tanque.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<p><img src="mapas/Fasnia.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<p><img src="mapas/Garachico.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<p><img src="mapas/La%20Guancha.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-10-tab">
<p><img src="mapas/La%20Matanza%20de%20Acentejo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-11-tab">
<p><img src="mapas/La%20Victoria%20de%20Acentejo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-12-tab">
<p><img src="mapas/Los%20Silos.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-13-tab">
<p><img src="mapas/San%20Juan%20de%20la%20Rambla.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-14-tab">
<p><img src="mapas/Santiago%20del%20Teide.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-15" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-15-tab">
<p><img src="mapas/Tegueste.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-16" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-16-tab">
<p><img src="mapas/Vilaflor.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
</div>
</div>
</section>
<section id="visor" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="visor"><span class="header-section-number">3.4</span> Visor</h2>
<iframe src="https://erensan-1.github.io/a3_visor/" width="100%" height="600px" style="border:none;">
</iframe>
</section>
</section>
<section id="análisis-del-residuo" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Análisis del residuo</h1>
<p>Un <strong>10,77%</strong> de las viviendas están asociadas a vías encontradas en el callejero de SITCAN que no están recogidas por el INE (codificación SITCAN &gt; 90.000), por lo que se trata de supuestos que se presentan como irresolubles para la tarea actual. Las vías a las que se asociarían dichas viviendas no existen actualmente en la base de datos del INE y por tanto requerirían de nueva alta por parte del ayuntamiento correspondiente.</p>
<p><img src="mapas/A3_vias_90000.png" class="img-fluid"></p>
<p>El porcentaje de registros de viviendas a resolver que presentan esta casuística varía notablemente para cada municipio:</p>
<div id="0df5d65a" class="cell" data-execution_count="23">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-24-output-1.png" width="1047" height="469" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>No obstante, dichas viviendas se reparten entre un número distinto de vías según cada municipio. Así pues, municipios con ayuntamientos pequeños y un componente alto de ruralidad y diseminación como El Tanque, Fasnia o Vilaflor de Chasna, muestran porcentajes más altos de vías sin codificar que municipios como Tegueste, Santiago del Teide o La Victoria de Acentejo, cuya menor dispersión poblacional presumiblemente favorece una mejor y más actualizada cobertura territorial.</p>
<div id="271a0368" class="cell" data-execution_count="24">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-25-output-1.png" width="1047" height="469" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cabc008f" class="cell" data-execution_count="25">
<div class="cell-output cell-output-display">
<p>El subconjunto de viviendas con estado 'A3_AsignarViaNueva' y sus vías se puede descargar <a href="vias_90000.xlsx" download="">aquí</a>.</p>
</div>
</div>
<p>Por otro lado, analizando las 10 direcciones con más registros, se constata la existencia de direcciones con difícil emparejamiento (pese a tener cvia_ine asignable por la vía espacial), como son ‘PROC. SIMPLIFICADO’, ‘DS DISEMINADOS’ o ‘DS DISEMINADO’, cuya suma asciende a 919 registros.</p>
<p>La suma de todos los registros cuya descripción hace referencia a las descripciones mencionadas o a un diseminado genérico (ej: DS GENOVES) asciende a más de 2000 registros. Esto último ha de tenerse en cuenta dado que limita la capacidad de emparejamiento literal o difuso de las descripciones, pese a que se haya resuelto la asignación de cvia_ine por la vía espacial.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>